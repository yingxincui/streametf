# ETF回测工具

这是一个基于Streamlit开发的ETF回测工具，支持组合回测、定投回测、动量策略、极值分析等多种功能。

## 功能特点

### 核心回测功能
- **组合回测**：支持多ETF组合的历史回测，可自定义权重，并可保存/加载自定义组合（保存于`portfolios.json`）
- **定投回测**：支持ETF定投策略的回测，可设置每月定投日和金额
- **有效前沿分析**：支持多ETF的蒙特卡洛模拟，展示最优风险收益组合、最小方差组合、等权重组合，并可保存/加载前沿分析组合（保存于`frontier_portfolios.json`）

### 策略分析功能
- **动量策略**：基于动量和均线的大类资产轮动策略，自动推荐持仓，支持自动计算
- **极值分析**：分析错过涨幅最多的N天对总收益的影响，量化择时的重要性
- **黑色星期四效应分析**：验证周内各交易日的涨跌趋势，分析周四效应是否存在

### 其他功能
- **性能指标**：计算总收益率、年化收益率、波动率、夏普比率、最大回撤等指标
- **可视化展示**：净值曲线、相关性矩阵、年度收益率、有效前沿图等多种图表
- **数据缓存**：智能缓存机制，提高数据获取效率

### 界面规范
- **颜色规则**：涨用红色，跌用绿色（符合中国股市习惯）

## 项目结构

```
├── app.py                              # 主应用入口
├── data.py                             # 数据获取相关函数
├── dca.py                              # 定投回测相关函数
├── metrics.py                          # 性能指标计算
├── portfolio.py                        # 组合回测相关函数
├── utils.py                            # 工具函数
├── pages/                              # 功能页面
│   ├── 1_组合回测.py                   # 组合回测页面
│   ├── 2_定投回测.py                   # 定投回测页面
│   ├── 3_有效前沿分析.py               # 有效前沿分析页面
│   ├── 4_动量策略.py                   # 动量策略页面
│   ├── 17_极值分析.py                  # 极值分析页面
│   ├── 18_black_thursday_analysis.py   # 黑色星期四效应分析页面
│   └── ...                             # 其他功能页面
├── config/                             # 配置文件
│   ├── favorite_etfs.json             # 收藏的ETF列表
│   └── wealth_freedom_saved.json      # 财富自由计算器保存数据
├── etf_cache/                         # ETF数据缓存目录
└── requirements.txt                    # 依赖包列表
```

## 安装与运行

1. 安装依赖包：

```bash
pip install -r requirements.txt
```

2. 运行应用：

```bash
streamlit run app.py
```

## 使用说明

### 组合回测

1. 在左侧面板选择至少2只ETF
2. 设置各ETF的权重（总和为100%）
3. 选择回测时间范围
4. 设置初始投资金额
5. 可输入组合名称并保存，或从下拉框加载已保存组合（保存于`portfolios.json`，仅回测功能使用）
6. 点击"运行回测"按钮

### 定投回测

1. 在左侧面板选择至少1只ETF
2. 设置各ETF的权重（总和为100%）
3. 选择定投时间范围
4. 设置每月定投金额和定投日
5. 点击"运行定投回测"按钮

### 有效前沿分析

1. 在左侧面板选择至少2只ETF，或从下拉框加载已保存的前沿分析组合（保存于`frontier_portfolios.json`，仅前沿分析功能使用）
2. 选择分析时间区间、无风险利率、模拟组合数量
3. 点击"运行有效前沿分析"按钮
4. 可输入组合名称并保存当前分析参数，便于下次快速加载
5. 右侧可查看所有模拟组合详情（收益、波动率、权重等均为百分比显示）

### 动量策略

1. 选择ETF池（默认包含6只主要ETF）
2. 设置动量周期、均线周期、最大持仓数量
3. 页面会自动计算并显示推荐持仓
4. 查看所有ETF的动量排名和均线状态
5. 支持手动刷新数据

### 极值分析

1. 选择要分析的ETF
2. 设置分析时间范围和初始投资金额
3. 设置要错过的涨幅最多天数（默认10天）
4. 系统会计算正常持有和错过最佳天数的收益对比
5. 显示详细的错过天数信息和累计收益对比图

### 黑色星期四效应分析

1. 选择要分析的ETF
2. 设置分析时间范围（近三年、近五年、近十年或全部数据）
3. 系统自动分析周一到周五的涨跌趋势
4. 查看各交易日的统计指标和可视化图表
5. 验证是否存在黑色星期四效应

## 数据来源

本工具使用AKShare获取ETF历史数据，数据来源为东方财富网。

## 更新日志

### 最新版本
- ✅ 新增动量策略自动计算功能
- ✅ 新增极值分析功能
- ✅ 新增黑色星期四效应分析功能
- ✅ 优化数据缓存机制
- ✅ 改进用户界面和交互体验

### 历史版本
- 支持组合回测和定投回测
- 支持有效前沿分析
- 支持性能指标计算和可视化