import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime, timedelta
from data import get_etf_list, fetch_etf_data_with_retry

# æ ‡å‡†æ™®å°”é…ç½®é¡µé¢
def sp500_portfolio_page():
    st.title("ğŸ¯ æ ‡å‡†æ™®å°”é…ç½®")
    
    # æ·»åŠ æ¦‚å¿µè®²è§£
    with st.expander("ğŸ” ä»€ä¹ˆæ˜¯æ ‡å‡†æ™®å°”å®¶åº­èµ„äº§é…ç½®å›¾ï¼Ÿ", expanded=True):
        st.markdown("""
        **æ ‡å‡†æ™®å°”å®¶åº­èµ„äº§é…ç½®å›¾**æ˜¯æ ‡å‡†æ™®å°”å…¬å¸é€šè¿‡è°ƒç ”å…¨çƒ10ä¸‡ä¸ªèµ„äº§ç¨³å¥å¢é•¿çš„å®¶åº­ï¼Œåˆ†ææ€»ç»“å‡ºçš„ä¸€å¥—æˆç†Ÿã€ç§‘å­¦çš„å®¶åº­èµ„äº§é…ç½®æ–¹å¼ã€‚
        
        æ ‡å‡†æ™®å°”å®¶åº­èµ„äº§é…ç½®å›¾æŠŠå®¶åº­èµ„äº§åˆ†æˆå››ä¸ªè´¦æˆ·ï¼Œè¿™å››ä¸ªè´¦æˆ·ä½œç”¨ä¸åŒï¼ŒæŠ•èµ„å·¥å…·ä¹Ÿå„ä¸ç›¸åŒï¼Œåªæœ‰æ‹¥æœ‰è¿™å››ä¸ªè´¦æˆ·ï¼Œå¹¶ä¸”æŒ‰ç…§å›ºå®šæ¯”ä¾‹è¿›è¡Œåˆ†é…ï¼Œæ‰èƒ½ä¿è¯å®¶åº­èµ„äº§é•¿æœŸã€æŒç»­ã€ç¨³å¥çš„å¢é•¿ã€‚
        
        ### ğŸ“Š å››ä¸ªè´¦æˆ·è¯¦è§£
        
        **ğŸ’° è¦èŠ±çš„é’±ï¼ˆ10%ï¼‰**
        - ä½œç”¨ï¼šçŸ­æœŸæ¶ˆè´¹ï¼Œ3-6ä¸ªæœˆçš„ç”Ÿæ´»è´¹
        - ä¿éšœï¼šç”¨äºæ—¥å¸¸å¼€é”€ã€æ—…æ¸¸ã€å¨±ä¹ç­‰
        - æŠ•èµ„å·¥å…·ï¼šæ´»æœŸç†è´¢ã€è´§å¸åŸºé‡‘ç­‰
        - ç‰¹ç‚¹ï¼šéšæ—¶å¯ä»¥æ”¯å–ï¼Œä¸ä¼šè´¬å€¼
        
        **ğŸ›¡ï¸ ä¿å‘½çš„é’±ï¼ˆ20%ï¼‰**
        - ä½œç”¨ï¼šä¿éšœçªå‘çš„å¤§é¢å¼€é”€
        - ä¿éšœï¼šè§£å†³é‡å¤§ç–¾ç—…ã€æ„å¤–ä¼¤å®³ç­‰é£é™©
        - æŠ•èµ„å·¥å…·ï¼šé‡ç–¾é™©ã€åŒ»ç–—é™©ã€æ„å¤–é™©ç­‰
        - ç‰¹ç‚¹ï¼šä¸“æ¬¾ä¸“ç”¨ï¼Œè§£å†³å®¶åº­çªå‘çš„å¤§å¼€æ”¯
        
        **ğŸ“ˆ ä¿æœ¬å‡å€¼çš„é’±ï¼ˆ30%ï¼‰**
        - ä½œç”¨ï¼šä¿éšœå®¶åº­èµ„äº§ç¨³å¥å¢é•¿
        - ä¿éšœï¼šå…»è€é‡‘ã€å­å¥³æ•™è‚²é‡‘ç­‰
        - æŠ•èµ„å·¥å…·ï¼šå€ºåˆ¸ã€ä¿¡æ‰˜ã€ç†è´¢é™©ç­‰
        - ç‰¹ç‚¹ï¼šæœ¬é‡‘å®‰å…¨ã€æ”¶ç›Šç¨³å®š
        
        **ğŸš€ ç”Ÿé’±çš„é’±ï¼ˆ40%ï¼‰**
        - ä½œç”¨ï¼šåˆ›é€ é«˜æ”¶ç›Š
        - ä¿éšœï¼šç”¨äºæŠ•èµ„å¢å€¼
        - æŠ•èµ„å·¥å…·ï¼šè‚¡ç¥¨ã€æˆ¿äº§ã€åŸºé‡‘ç­‰
        - ç‰¹ç‚¹ï¼šé«˜æ”¶ç›Šã€é«˜é£é™©
        
        ### ğŸ¯ é…ç½®åŸåˆ™
        - æŒ‰ç…§10%ã€20%ã€30%ã€40%çš„æ¯”ä¾‹åˆ†é…
        - æ ¹æ®å®¶åº­å®é™…æƒ…å†µçµæ´»è°ƒæ•´
        - å®šæœŸè¯„ä¼°å’Œå†å¹³è¡¡
        """)
    
    # å››è´¦æˆ·é…ç½®å»ºè®®
    st.header("ğŸ’¡ å››è´¦æˆ·é…ç½®å»ºè®®")
    
    # è¦èŠ±çš„é’±
    st.subheader("ğŸ’° è¦èŠ±çš„é’± (10%)")
    st.markdown("""
    - **æŠ•èµ„å·¥å…·**ï¼šè´§å¸åŸºé‡‘ã€é“¶è¡Œæ´»æœŸç†è´¢
    - **æ¨èETF**ï¼š
      - 511090.SH (æµ¦é“¶å®‰ç››æ—¥æ—¥ç›ˆETF) - è´§å¸å‹ETF
      - 511380.SH (åå®æ·»ç›Š) - è´§å¸å‹ETF
    - **ç‰¹ç‚¹**ï¼šæµåŠ¨æ€§å¥½ï¼Œé£é™©æä½ï¼Œæ”¶ç›Šç¨³å®š
    """)
    
    # ä¿å‘½çš„é’±
    st.subheader("ğŸ›¡ï¸ ä¿å‘½çš„é’± (20%)")
    st.markdown("""
    - **æŠ•èµ„å·¥å…·**ï¼šä¿é™©äº§å“ï¼ˆä¸åœ¨ETFèŒƒå›´å†…ï¼‰
    - **å»ºè®®**ï¼šè´­ä¹°é‡ç–¾é™©ã€åŒ»ç–—é™©ã€æ„å¤–é™©ç­‰
    - **ç‰¹ç‚¹**ï¼šä¸“æ¬¾ä¸“ç”¨ï¼Œä¿éšœçªå‘å¤§é¢æ”¯å‡º
    """)
    
    # ä¿æœ¬å‡å€¼çš„é’±
    st.subheader("ğŸ“ˆ ä¿æœ¬å‡å€¼çš„é’± (30%)")
    st.markdown("""
    - **æŠ•èµ„å·¥å…·**ï¼šå€ºåˆ¸ETFã€å›½å€ºETF
    - **æ¨èETF**ï¼š
      - 511010.SH (å›½å€ºETF) - å›½å€ºETF
      - 511220.SH (åŸæŠ•å€ºETF) - å€ºåˆ¸ETF
    - **ç‰¹ç‚¹**ï¼šæœ¬é‡‘å®‰å…¨ï¼Œæ”¶ç›Šç¨³å®š
    """)
    
    # ç”Ÿé’±çš„é’±
    st.subheader("ğŸš€ ç”Ÿé’±çš„é’± (40%)")
    st.markdown("""
    - **æŠ•èµ„å·¥å…·**ï¼šè‚¡ç¥¨ETFã€å®½åŸºæŒ‡æ•°ETF
    - **æ¨èETF**ï¼š
      - 510300.SH (æ²ªæ·±300ETF) - å¤§ç›˜è‚¡ETF
      - 510500.SH (ä¸­è¯500ETF) - ä¸­ç›˜è‚¡ETF
      - 510310.SH (ä¸Šè¯50ETF) - å¤§ç›˜è‚¡ETF
      - 512890.SH (é“¶è¡ŒETF) - è¡Œä¸šETF
      - 512010.SH (åŒ»è¯ETF) - è¡Œä¸šETF
    - **ç‰¹ç‚¹**ï¼šé«˜é£é™©é«˜æ”¶ç›Šï¼Œé•¿æœŸå¢å€¼æ½œåŠ›å¤§
    """)
    
    # èµ„é‡‘åˆ†é…è®¡ç®—å™¨
    st.header("ğŸ§® èµ„é‡‘åˆ†é…è®¡ç®—å™¨")
    st.markdown("""
    æ ¹æ®æ ‡å‡†æ™®å°”å®¶åº­èµ„äº§é…ç½®å›¾ï¼Œæ‚¨å¯ä»¥è¾“å…¥æ€»èµ„é‡‘ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨è®¡ç®—å„è´¦æˆ·çš„åˆ†é…é‡‘é¢ã€‚
    """)
    
    # ç”¨æˆ·è¾“å…¥æ€»èµ„é‡‘
    total_fund = st.number_input("è¯·è¾“å…¥æ‚¨çš„æ€»èµ„é‡‘ (å…ƒ)", min_value=0.0, value=100000.0, step=1000.0, format="%.2f")
    
    if total_fund > 0:
        # è®¡ç®—å„è´¦æˆ·åˆ†é…é‡‘é¢
        spend_fund = total_fund * 0.10
        insurance_fund = total_fund * 0.20
        stable_fund = total_fund * 0.30
        investment_fund = total_fund * 0.40
        
        # æ˜¾ç¤ºåˆ†é…ç»“æœ
        st.subheader("ğŸ“Š èµ„é‡‘åˆ†é…ç»“æœ")
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric(label="ğŸ’° è¦èŠ±çš„é’± (10%)", value=f"Â¥{spend_fund:,.2f}")
        with col2:
            st.metric(label="ğŸ›¡ï¸ ä¿å‘½çš„é’± (20%)", value=f"Â¥{insurance_fund:,.2f}")
        with col3:
            st.metric(label="ğŸ“ˆ ä¿æœ¬å‡å€¼çš„é’± (30%)", value=f"Â¥{stable_fund:,.2f}")
        with col4:
            st.metric(label="ğŸš€ ç”Ÿé’±çš„é’± (40%)", value=f"Â¥{investment_fund:,.2f}")
        
        # æ˜¾ç¤ºæ¨èETFæŠ•èµ„åˆ†é…
        st.subheader("ğŸ“ˆ æ¨èETFæŠ•èµ„åˆ†é…")
        st.markdown("""
        æ ¹æ®å„è´¦æˆ·ç‰¹ç‚¹ï¼Œä¸ºæ‚¨æ¨èä»¥ä¸‹ETFæŠ•èµ„æ–¹æ¡ˆï¼š
        """)
        
        # è¦èŠ±çš„é’±ETFåˆ†é…
        st.markdown("**ğŸ’° è¦èŠ±çš„é’± (10%)**")
        st.write(f"- 511090.SH (æµ¦é“¶å®‰ç››æ—¥æ—¥ç›ˆETF): Â¥{spend_fund * 0.5:,.2f}")
        st.write(f"- 511380.SH (åå®æ·»ç›Š): Â¥{spend_fund * 0.5:,.2f}")
        
        # ä¿æœ¬å‡å€¼çš„é’±ETFåˆ†é…
        st.markdown("**ğŸ“ˆ ä¿æœ¬å‡å€¼çš„é’± (30%)**")
        st.write(f"- 511010.SH (å›½å€ºETF): Â¥{stable_fund * 0.6:,.2f}")
        st.write(f"- 511220.SH (åŸæŠ•å€ºETF): Â¥{stable_fund * 0.4:,.2f}")
        
        # ç”Ÿé’±çš„é’±ETFåˆ†é…
        st.markdown("**ğŸš€ ç”Ÿé’±çš„é’± (40%)**")
        st.write(f"- 510300.SH (æ²ªæ·±300ETF): Â¥{investment_fund * 0.3:,.2f}")
        st.write(f"- 510500.SH (ä¸­è¯500ETF): Â¥{investment_fund * 0.25:,.2f}")
        st.write(f"- 510310.SH (ä¸Šè¯50ETF): Â¥{investment_fund * 0.2:,.2f}")
        st.write(f"- 512890.SH (é“¶è¡ŒETF): Â¥{investment_fund * 0.15:,.2f}")
        st.write(f"- 512010.SH (åŒ»è¯ETF): Â¥{investment_fund * 0.1:,.2f}")
        
        # æ€»ç»“
        st.info(f"ğŸ’¡ æ‚¨çš„æ€»èµ„é‡‘ Â¥{total_fund:,.2f} å·²æŒ‰æ ‡å‡†æ™®å°”é…ç½®å›¾å®Œæˆåˆ†é…å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ï¼")
    else:
        st.info("è¯·è¾“å…¥æ‚¨çš„æ€»èµ„é‡‘ä»¥æŸ¥çœ‹åˆ†é…å»ºè®®")
    
    # é…ç½®ä¼˜åŒ–å»ºè®®
    st.header("ğŸ¯ é…ç½®ä¼˜åŒ–å»ºè®®")
    st.markdown("""
    ### ğŸ“‹ å®æ–½æ­¥éª¤
    1. **è¯„ä¼°ç°çŠ¶**ï¼šç›˜ç‚¹ç°æœ‰èµ„äº§ï¼Œç¡®å®šå„è´¦æˆ·èµ„é‡‘ç¼ºå£
    2. **åˆ†æ­¥é…ç½®**ï¼šæŒ‰æ¯”ä¾‹é€æ­¥é…ç½®å„è´¦æˆ·
    3. **å®šæœŸè°ƒæ•´**ï¼šæ¯å¹´æˆ–æ¯åŠå¹´è¯„ä¼°ä¸€æ¬¡ï¼Œè¿›è¡Œå†å¹³è¡¡
    4. **åŠ¨æ€ä¼˜åŒ–**ï¼šæ ¹æ®å¸‚åœºå˜åŒ–å’Œä¸ªäººæƒ…å†µè°ƒæ•´é…ç½®
    
    ### âš ï¸ æ³¨æ„äº‹é¡¹
    - é…ç½®æ¯”ä¾‹å¯æ ¹æ®ä¸ªäººé£é™©æ‰¿å—èƒ½åŠ›é€‚å½“è°ƒæ•´
    - æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…
    - å»ºè®®å’¨è¯¢ä¸“ä¸šç†è´¢é¡¾é—®
    """)
    
    # å†å²è¡¨ç°
    st.header("ğŸ“ˆ å†å²è¡¨ç°")
    st.info("æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…å†å²è¡¨ç°åˆ†æåŠŸèƒ½...")

# é¡µé¢å…¥å£
if __name__ == "__main__":
    sp500_portfolio_page()